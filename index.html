<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>BRRRT! — Site</title>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>

<style>
/* ================= FONTS ================= */
@font-face {
  font-family: 'KomikaTitle';
  src: url('fonts/KOMIKAGL.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
}
@font-face {
  font-family: 'KomikaText';
  src: url('fonts/Komika.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
}
@font-face {
  font-family: 'CourierNewt';
  src: url('fonts/Courier New.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
}

:root{
  /* --- COLOR INVERSION (Light Mode) --- */
  --bg:#f2f2f2;       
  --bg-page2: #e8e8e8; 
  --bg-page3: #dedede; 
  
  --text-main:#1a1a1a;
  --muted:#666666;    
  --accent:#ff4444;   
  --btn:#e0e0e0;      
  --btn-text:#000;    
  --sfx-bg:#d0d0d0;   
  --sfx-border:#b0b0b0;
  
  --waveform-fill: #b0b0b0; 
  --waveform-progress: var(--accent);
  
  --logo-filter: none; 
}

/* --- DARK MODE VARIABLES --- */
[data-theme="dark"] {
  --bg: #202225;       
  --bg-page2: #2f3136; 
  --bg-page3: #36393f; 
  
  --text-main: #dcddde;
  --muted: #b9bbbe;    
  --btn: #40444b;      
  --btn-text: #ffffff; 
  --sfx-bg: #2f3136;   
  --sfx-border: #202225;
  
  --waveform-fill: #4f545c; 
  --waveform-progress: var(--accent);
  
  --logo-filter: invert(1) grayscale(100%) brightness(1.5);
}

html,body{
  min-height:100%; 
  margin:0;
  background:var(--bg); 
  color:var(--text-main); 
  font-family: 'Courier New', Arial, Helvetica, sans-serif;
  -webkit-font-smoothing:antialiased;
  overflow-x:hidden;
  transition: background-color 0.3s ease, color 0.3s ease;
  user-select: none;
  -webkit-user-select: none;
}
*{box-sizing:border-box}

section{
    width:100%;
    min-height:100vh;
    display:flex;
    flex-direction:column;
    align-items:center; 
    transition: background-color 0.3s ease;
}

#page1{
    padding-top:0px; 
    padding-left:8px;
    padding-right:8px; 
    position: relative;
    background-color: var(--bg);
}

/* ================= HEADER ROW ================= */
.top-header {
    width: 100%;
    display: flex;
    justify-content: flex-end; 
    align-items: center;
    padding: 20px 60px 0 60px; 
    margin-bottom: 0px; 
    box-sizing: border-box;
    height: 60px;
}

#theme-icon-container {
    width: 32px;
    height: 32px;
    color: var(--text-main);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: color 0.3s ease;
    pointer-events: auto;
}

@keyframes iconPop {
    0% { opacity: 0; transform: scale(0.5) rotate(-20deg); }
    70% { transform: scale(1.1) rotate(20deg); } 
    100% { opacity: 1; transform: scale(1) rotate(0deg); } 
}

.icon-enter {
    animation: iconPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

.theme-switch-wrapper { display: none; }
.theme-switch input { display: none; }

/* ================= SCROLL ARROW ================= */
#scroll-arrow {
    position: absolute;
    bottom: 5vh;
    left: 50%;
    transform: translateX(-50%);
    color: var(--text-main);
    animation: bounce 2s infinite;
    opacity: 1;
    pointer-events: none; 
    z-index: 100;
}

@keyframes bounce {
  0%, 20%, 50%, 80%, 100% { transform: translateX(-50%) translateY(0); }
  40% { transform: translateX(-50%) translateY(-10px); }
  60% { transform: translateX(-50%) translateY(-5px); }
}

/* Titles using KOMIKAGL */
.title-main {
  font-family: 'Komika', sans-serif;
  font-size:28px;
  line-height:1;
  margin: -15px 0 0; 
  font-weight:normal;
  letter-spacing:0.5px
}
.title-sub{font-size:18px;margin:2px 0 6px;color:var(--muted)}

#player{display:flex;flex-direction:column;align-items:center;width:100%;max-width:420px;padding-bottom:6px}

/* Controls */
#controls{margin-top:6px;width:240px;display:flex;justify-content:space-between;align-items:center}
.control-btn{
  background:var(--btn);
  border:1px solid #ccc; 
  color:var(--btn-text);
  padding:4px 2px;
  border-radius:8px;
  font-size:14px;
  cursor:pointer;
  width:80px;
  min-width:72px;
  text-align:center;
  position:relative;
  overflow:visible; 
  font-family: 'KomikaText', sans-serif;
  transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
}

[data-theme="dark"] .control-btn { border-color: #202225; }

.hidden{ visibility:hidden; opacity:0; pointer-events:none; }
#likeButton { display:inline-flex; align-items:center; justify-content:center; }
#likeButton::after{ content: attr(data-icon); display:block; width:100%; text-align:center; font-size:16px; line-height:1; pointer-events:none; }
#likeButton.liked { background: var(--accent); color: #fff; border-color:var(--accent); }

.disabled-btn { opacity: 0.5; pointer-events: none; } 

/* --- FLEXBOX FIX FOR JOG WHEEL --- */
#wheelRow {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  max-width: 420px;
  margin-top: 8px;
}
#wheelRow > div:first-child { flex: 1; width: 0; }
#wheelCell { flex: 0 0 auto; display: flex; justify-content: center; align-items: center; }
#volumeCell {
  flex: 1;
  width: 0; 
  display: flex;
  justify-content: flex-start;
  align-items: center;
  padding-left: 6px;
  transform: translateX(-60px); 
}

#jog-wheel{
  width:120px;height:120px;border-radius:50%;
  background: url('wheel.jpg') no-repeat center/cover;
  transform-origin:50% 50%;
  touch-action:none; 
  flex: 0 0 auto;
  cursor: grab;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
  position: relative;
  overflow: hidden; 
}
#jog-wheel:active { cursor: grabbing; }

#albumArt {
  width: 100%; 
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
  position: absolute;
  top: 0; left: 0;
  pointer-events: none; 
  display: none; 
  z-index: 1;
}

.volume-wrap{
  display:flex;flex-direction:column;align-items:center;gap:8px;
  user-select:none;touch-action:none;
  margin-left:8px;transform: scale(0.7);transform-origin: center top;
}
.volume-label{font-size:12px;color:var(--muted);margin-bottom:2px}
.volume-slider{ -webkit-appearance:none; appearance:none; width:110px; height:26px; background:transparent; transform: rotate(-90deg); outline:none; cursor:pointer; }
.volume-slider::-webkit-slider-runnable-track{ width:100%; height:6px; background:#ccc; border-radius:6px; }
.volume-slider::-webkit-slider-thumb{ -webkit-appearance:none; width:18px;height:18px;border-radius:50%;background:#fff;margin-top:-6px; box-shadow:0 0 0 3px rgba(255,68,68,0.2); border: 1px solid #ddd; }

#trackName{
  margin-top:6px;
  color:var(--muted);
  font-size:16px;
  height: 20px; 
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 1;
}

@keyframes softFade { 0% { opacity: 0; transform: translateY(0px); } 100% { opacity: 1; transform: translateY(0); } }
.fade-in { animation: softFade 0.25s ease-out forwards; }

#waveformContainer {
    width: 100%;
    max-width: 80px;
    height: 30px; 
    margin-top: 2px; 
    display: flex;
    justify-content: center; 
    align-items: center;
    cursor: default; 
}
#waveformCanvas { width: 100%; height: 100%; display: block; }

.sfx-block{margin-top:2px;display:flex;flex-direction:column;align-items:center;width:100%}
#sfx-grid-inner{display:grid;grid-template-columns:repeat(3,80px);grid-gap:10px;justify-content:center;margin-top:2px}
.sfx-button{
  width:80px;height:80px;border-radius:8px;
  background:var(--sfx-bg);
  border:2px solid var(--sfx-border);
  display:flex;align-items:center;justify-content:center;
  font-size:16px;cursor:pointer;user-select:none;position:relative;
  color:var(--text-main);
  font-family: 'KomikaTitle', sans-serif;
  transition: background-color 0.2s, border-color 0.2s, color 0.2s;
}
.sfx-number{position:absolute;top:6px;left:50%;transform:translateX(-50%);pointer-events:none;font-weight:normal;font-size:14px; opacity:0.6;}
.sfx-button:active{transform:scale(0.97);background:var(--accent); color:#fff; border-color:var(--accent);}
.flash-red { animation: flickerRed 0.2s ease-out forwards; }
#refreshButton{margin-top:12px;padding:8px 16px;font-size:14px;background:var(--btn);color:var(--btn-text);border:1px solid #ccc;border-radius:8px;cursor:pointer; font-family: 'KomikaText', sans-serif;}

#page2, #page3 { 
  padding:18px; 
  display:flex; 
  flex-direction:column; 
  align-items:center; 
  text-align:center; 
  background-color: var(--bg-page2); 
  transition: background-color 0.3s ease;
}
#page3 { background-color: var(--bg-page3); }

.page2-title, .page3-title { 
  font-family: 'Komika', sans-serif;
  padding-top:28px; 
  font-size:40px; 
  font-weight:normal; 
  margin-bottom:12px; 
  color: var(--text-main);
}
.page2-text, .page3-text { max-width:720px; color:var(--muted); text-align:left; margin:6px 8px; font-size:20px; line-height:1.45; }
.page2-photo, .page3-photo { margin-top:14px; border-radius:8px; object-fit:contain; width:50%; height:auto; }

#partners-strip{ position:relative; width:100%; overflow:hidden; height:200px; margin-top:100px; display:flex; align-items:center; touch-action: none; }
#partners-strip-inner{ display:flex; min-width: 200%; top:50%; transform:translateY(-50%); will-change: transform; }
#partners-strip-inner img{ height:60px; width: auto; object-fit: contain; margin:0 32px; display:inline-block; filter: var(--logo-filter); transition: filter 0.3s ease; }

@keyframes flickerRed{ 0%{background:var(--sfx-bg)} 50%{background:#ff4444} 100%{background:var(--sfx-bg)} }

@media (max-width:980px){ .page2-photo, .page3-photo{ width:60%; } }
@media (max-width:720px){
  .page2-photo, .page3-photo{ width:90%; }
  .page2-text{ text-align:left; font-size:14px; }
  .title-main{font-size:24px}
  #jog-wheel{width:100px;height:100px}
  #sfx-grid-inner{grid-template-columns:repeat(3,64xpx);grid-gap:px}
  .sfx-button{width:72px;height:72px;font-size:14px}
  .control-btn{width:72px;font-size:13px;padding:6px}
  #trackName{font-size:16px}
  #partners-strip{ height: 80px; margin-top: 30px; }
  #partners-strip-inner img{ height:48px; margin:0 24px; }
  #waveformContainer { height: 20px; }
  .top-header { padding: 10px 20px 0 20px; }
}
</style>
</head>
<body oncontextmenu="return false;" ondragstart="return false;" ondrop="return false;">

<section id="page1">
  <div class="top-header">
      <div id="theme-icon-container" aria-label="Toggle Dark Mode">
          </div>
      <div class="theme-switch-wrapper">
        <label class="theme-switch" for="checkbox">
            <input type="checkbox" id="checkbox" />
        </label>
      </div>
  </div>

  <div style="text-align:center;">
    <div class="title-main">BRRRT¡</div>
    <div class="title-sub">audio studio</div>
  </div>

  <div id="player">
    <div id="controls">
      <button id="likeButton" class="control-btn hidden" data-icon="♡" aria-label="Like"></button>
      <button id="playButton" class="control-btn">Play</button>
      <button id="nextButton" class="control-btn hidden">Next</button>
    </div>

    <div id="wheelRow">
      <div></div>
      <div id="wheelCell">
        <div id="jog-wheel" role="slider" aria-label="Jog wheel">
            <img id="albumArt" src="" alt="Album Art">
        </div>
      </div>
      <div id="volumeCell">
        <div class="volume-wrap">
          <div class="volume-label">Vol</div>
          <input id="volumeSlider" class="volume-slider" type="range" min="0" max="1" step="0.01" aria-label="Music volume">
        </div>
      </div>
    </div>

    <div id="trackName"></div>
    <div id="waveformContainer"><canvas id="waveformCanvas"></canvas></div>
    <div class="sfx-block" aria-label="SFX pads and refresh">
      <div id="sfx-grid-inner"></div>
      <button id="refreshButton" aria-label="Refresh SFX">Reload</button>
    </div>
  </div>

  <div id="scroll-arrow">
    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 13l5 5 5-5M7 6l5 5 5-5"/></svg>
  </div>
</section>

<section id="page2">
  <div style="text-align:center;margin-top:6px">
    <div class="page2-title">We put everything in context</div>
  </div>
  <div class="page2-text">
    We love to play games! So we truly understand the experience from the 
    player perspective, and that helps us build an original 
    auditory concept tailored to your game through our unique workflow
    that also involves dynamic music and optimized sound systems that flatter the gameplay, thus enhances the player immersion
    We work closely with the creative & dev, in & out of the engine and we sync with production timeline

  </div>
  <img class="page2-photo" src="photo1.png" alt="photo1">
</section>

<section id="page3">
  <div style="text-align:center;margin-top:6px">
    <div class="page3-title">Job your love</div>
    <div class="page3-text">
      BRRRT¡ Is based In sunny Lisbon and our studio is further down the valley where its magical, inspiring us with creativity and focus.
      You can Reach out below through our links, or by asking some of our beloved partners about us..
      lets make your game shine!
    </div> 
  </div>
  <img class="page3-photo" src="contact-photo.png" alt="Contact photo">
  
  <div style="display:flex; flex-wrap: wrap; align-items:center; justify-content:center; gap:16px; margin-top:12px; width:100%; max-width:420px;">
    <div style="display:flex; align-items:center; gap:10px;">
      <span style="font-family:'KomikaText', sans-serif; color:var(--muted); font-size:16px; text-align: right;">instagram</span>
      <a href="https://www.instagram.com/brrrt.audio/" target="_blank" rel="noopener" class="control-btn" style="width:48px; height:48px; min-width:48px; font-size:22px; padding:0; display:flex; align-items:center; justify-content:center; text-decoration:none; color:var(--btn-text);">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>
      </a>
    </div>

    <div style="display:flex; align-items:center; gap:10px;">
      <span id="copyFeedback" style="font-family:'KomikaText', sans-serif; color:var(--muted); font-size:16px; width: 150px; text-align: right; display: inline-block;">copy to clipboard</span>
      <button id="copyEmailBtn" class="control-btn" style="width:48px; height:48px; min-width:48px; font-size:22px; padding:0; display:flex; align-items:center; justify-content:center;" aria-label="Copy Email">
        ❐
      </button>
    </div>
  </div>

  <div id="partners-strip">
    <div id="partners-strip-inner">
      <img src="visual/partners/icy_ghost.png" alt="Icy Ghost Logo">
      <img src="visual/partners/sneakyp.png" alt="Sneakyp Logo">
      <img src="visual/partners/microsoft.png" alt="Microsoft Logo"> 
      <img src="visual/partners/scopely.png" alt="Scopely Logo"> 
      <img src="visual/partners/lootheads.png" alt="Lootheads Logo"> 
      <img src="visual/partners/whalo.png" alt="Whalo Logo"> 
      <img src="visual/partners/hearsay.png" alt="Hearsay Logo"> 
      <img src="visual/partners/glaive.png" alt="Glaive Logo"> 
      <img src="visual/partners/okami.png" alt="Okami Logo"> 
      <img src="visual/partners/playspark.png" alt="Playspark Logo"> 
      <img src="visual/partners/parana.png" alt="Parana Logo"> 
      <img src="visual/partners/uni.png" alt="Uni Logo"> 
      <img src="visual/partners/candivore.png" alt="Candivore Logo"> 
      <img src="visual/partners/lineup.png" alt="Lineup Logo"> 
      <img src="visual/partners/obscure.png" alt="Obscure Logo"> 
      <img src="visual/partners/jelly.png" alt="Jelly Logo"> 
      <img src="visual/partners/heimdall.png" alt="Heimdall Logo">
    </div>
  </div>
</section>

<script>
document.onkeydown = function(e) {
    if (e.keyCode == 123) { return false; } 
    if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { return false; } 
    if (e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) { return false; } 
    if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) { return false; } 
    if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { return false; } 
    if (e.ctrlKey && e.keyCode == 'S'.charCodeAt(0)) { return false; } 
};

const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audioContext = new AudioCtx();
const musicGain = audioContext.createGain();
musicGain.connect(audioContext.destination);

const firebaseConfig = {
  apiKey: "AIzaSyDebtA94th7vA4dNOCVBgHnzG07_UaSkmM",
  authDomain: "brrrt-audio.firebaseapp.com",
  projectId: "brrrt-audio",
  storageBucket: "brrrt-audio.firebasestorage.app",
  messagingSenderId: "280094161378",
  appId: "1:280094161378:web:c20952c2c40b23db4461bb",
  measurementId: "G-SN37YNEW66"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const analytics = firebase.analytics();

const savedVolume = localStorage.getItem('brrrt_music_volume')!==null ? parseFloat(localStorage.getItem('brrrt_music_volume')) : 0.8;
musicGain.gain.value = savedVolume;
let likes=JSON.parse(localStorage.getItem('trackLikes')||'{}');

/* State Variables */
let audioBuffer=null, source=null;
let isPlaying = false;
let currentTrack = null; 
let lastPlayedTrackUrl = ''; 
let trackQueue = []; 

/* Vinyl Physics */
let isScrubbing = false;
let isHolding = false;
let playHeadTime = 0;       
let currentVelocity = 0;    
let targetVelocity = 0;     
let wheelRotation = 0;
let lastPointerX = 0;
let lastTimestamp = performance.now(); 

/* Waveform */
let waveformPeaks = []; 
const canvas = document.getElementById('waveformCanvas');
const ctx = canvas.getContext('2d');
const DENSITY_FACTOR = 6; 

const playButton=document.getElementById('playButton');
const nextButton=document.getElementById('nextButton');
const likeButton=document.getElementById('likeButton');
const jogWheel=document.getElementById('jog-wheel');
const trackNameDiv=document.getElementById('trackName');
const volumeSlider=document.getElementById('volumeSlider');
volumeSlider.value=savedVolume; 
const albumArtImg = document.getElementById('albumArt'); 

const musicPath='audio/music/';
const trackList=[
    { url: 'Afternoon Adventure.ogg', display: 'Afternoon Adventure' },
    { url: 'a Swing Of Cards.ogg', display: 'a Swing Of Cards' },
    { url: 'Count The Yellow Cars.ogg', display: 'Count The Yellow Cars' },
    { url: 'Premium Dice.ogg', display: 'Premium Dice' },
    { url: 'Digital Dungeon.ogg', display: 'Digital Dungeon' },
    { url: 'Her Majesty (w.Jane Perry).ogg', display: 'Her Majesty (w.Jane Perry)' },
    { url: 'Factory Settings.ogg', display: 'Factory Settings' },
    { url: 'Fits In My Garage.ogg', display: 'Fits In My Garage' }, 
    { url: 'Halloween Machine.ogg', display: 'Halloween Machine' },
    { url: 'Island Lovers.ogg', display: 'Island Lovers' },
    { url: 'Hunted Dungeon.ogg', display: 'Hunted Dungeon' },
    { url: 'Id Love To Be There.ogg', display: 'Id Love To Be There' },
    { url: 'Mansion Halls.ogg', display: 'Mansion Halls' },
    { url: 'Match Masters Theme (Live).ogg', display: 'Match Masters Theme (Live)' },
    { url: 'Retroy.ogg', display: 'Retroy' },
    { url: 'Thats One Busy Lobby.ogg', display: 'Thats One Busy Lobby' },
    { url: 'The Good Ol Candyland.ogg', display: 'The Good Ol Candyland' },
    { url: 'The Voltgard Climb.ogg', display: 'The Voltgard Climb' },
    { url: 'Trick Or Deal.ogg', display: 'Trick Or Deal' },
    { url: 'Warm Winter Cabin.ogg', display: 'Warm Winter Cabin' },
    { url: 'Memory Trail.ogg', display: 'Memory Trail' },
    { url: 'Amongst Us.ogg', display: 'Amongst Us' },
    { url: 'Annual Parade.ogg', display: 'Annual Parade' },
    { url: 'Avast Ye!.ogg', display: 'Avast Ye!' },
    { url: 'Magical Cave.ogg', display: 'Magical Cave' },
    { url: 'Family Holiday.ogg', display: 'Family Holiday' },
    { url: 'Tequilla Sunset.ogg', display: 'Tequilla Sunset' },
    { url: 'Forest Day Picking.ogg', display: 'Forest Day Picking' },
    { url: 'Back Home.ogg', display: 'Back Home' },
    { url: 'Tokya.ogg', display: 'Tokya' },
    { url: 'Taverna Logic.ogg', display: 'Taverna Logic' },
    { url: 'Ode To Oud.ogg', display: 'Ode To Oud' },
    { url: 'Desert Nights.ogg', display: 'Desert Nights' },
    { url: 'Urban Museum Visit.ogg', display: 'Urban Museum Visit' },
    { url: 'Raiders Of Sand.ogg', display: 'Raiders Of Sand' },
    { url: 'Chasing Goats.ogg', display: 'Chasing Goats' },
    { url: 'Lobby Encounter.ogg', display: 'Lobby Encounter' },
    { url: 'Mystery Bit.ogg', display: 'Mystery Bit' },
    { url: 'Shazi Appeal.ogg', display: 'Shazi Appeal' },
    { url: 'Chicago Bullys.ogg', display: 'Chicago Bullys' },
    { url: 'One Last Heist.ogg', display: 'One Last Heist' },
    { url: 'Punk Masters.ogg', display: 'Punk Masters' },
    { url: 'Space Masters.ogg', display: 'Space Masters' },
    { url: 'Animate This!.ogg', display: 'Animate This!' },
    { url: 'Mall Mayhem.ogg', display: 'Mall Mayhem' },
    { url: 'Dad Jeans.ogg', display: 'Dad Jeans' },
    { url: 'Swing Masters.ogg', display: 'Swing Masters' },
    { url: 'Crumbs Of Justice.ogg', display: 'Crumbs Of Justice' },
    { url: 'Man O War.ogg', display: 'Man O War' },
    { url: 'Mountain Oddissey.ogg', display: 'Mountain Oddissey' },
    { url: 'New Type Of Evil.ogg', display: 'New Type Of Evil' },
    { url: 'Path Of The Gecko.ogg', display: 'Path Of The Gecko' },
    { url: 'Rift Of Riffs.ogg', display: 'Rift Of Riffs' },
    { url: 'Sneaky Orc.ogg', display: 'Sneaky Orc' },
    { url: 'Solarian Flare.ogg', display: 'Solarian Flare' },
    { url: 'Tectonic Rumble.ogg', display: 'Tectonic Rumble' },
    { url: 'Terak Path.ogg', display: 'Terak Path' },
    { url: 'Underworld Roaming.ogg', display: 'Underworld Roaming' },
    { url: 'Analouge Heist.ogg', display: 'Analouge Heist' },
    { url: 'Drift Funnel.ogg', display: 'Drift Funnel' },
    { url: 'TP For My Townhall.ogg', display: 'TP For My Townhall' },
    { url: 'Trap Boy.ogg', display: 'Trap Boy' },
    { url: 'Saving Harold.ogg', display: 'Saving Harold' },
    { url: 'Day Of The Raid.ogg', display: 'Day Of The Raid' },
];

let tracks = trackList.map(t => ({
    url: musicPath + encodeURI(t.url),
    display: t.display
}));

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

function getNextTrackFromQueue() {
    if (trackQueue.length === 0) {
        trackQueue = [...tracks]; 
        shuffleArray(trackQueue); 
        if (currentTrack && trackQueue.length > 1 && trackQueue[0].url === currentTrack.url) {
            const swapIndex = Math.floor(Math.random() * (trackQueue.length - 1)) + 1;
            [trackQueue[0], trackQueue[swapIndex]] = [trackQueue[swapIndex], trackQueue[0]];
        }
    }
    return trackQueue.pop(); 
}

function getWaveformPeaks(audioBuffer, width) {
    if (!audioBuffer) return [];
    const data = audioBuffer.getChannelData(0); 
    const totalSamples = data.length;
    const peaks = [];
    const numPeaksToDraw = Math.ceil(width / DENSITY_FACTOR); 
    const samplesPerPeak = totalSamples / numPeaksToDraw; 
    for (let i = 0; i < numPeaksToDraw; i++) {
        const startSample = Math.floor(i * samplesPerPeak);
        const endSample = Math.floor((i + 1) * samplesPerPeak);
        let maxPeak = 0;
        for (let j = startSample; j < endSample; j++) {
            const sample = Math.abs(data[j]);
            if (sample > maxPeak) maxPeak = sample;
        }
        peaks.push(maxPeak);
    }
    return peaks;
}

function drawWaveform() {
    if (!audioBuffer || waveformPeaks.length === 0) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return;
    }
    const width = canvas.offsetWidth;
    const height = canvas.offsetHeight;
    if (canvas.width !== width || canvas.height !== height) {
        canvas.width = width;
        canvas.height = height;
        waveformPeaks = getWaveformPeaks(audioBuffer, width); 
    }
    ctx.clearRect(0, 0, width, height);
    const center = height / 2;
    const totalDuration = audioBuffer.duration;
    const peakBarWidth = width / waveformPeaks.length; 
    const playedX = Math.min(width, Math.max(0, (playHeadTime / totalDuration) * width)); 

    ctx.beginPath();
    ctx.lineCap = 'butt';
    ctx.lineWidth = 1;
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--waveform-fill');
    for (let i = 0; i < waveformPeaks.length; i++) {
        const x = i * peakBarWidth; 
        const peak = waveformPeaks[i];
        const barHeight = Math.max(1, peak * height * 0.9); 
        ctx.moveTo(x, center - barHeight / 2);
        ctx.lineTo(x, center + barHeight / 2);
    }
    ctx.stroke();

    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--waveform-progress');
    ctx.beginPath();
    for (let i = 0; i < waveformPeaks.length; i++) {
        const x = i * peakBarWidth; 
        if (x > playedX) break; 
        const peak = waveformPeaks[i];
        const barHeight = Math.max(1, peak * height * 0.9);
        ctx.moveTo(x, center - barHeight / 2);
        ctx.lineTo(x, center + barHeight / 2);
    }
    ctx.stroke();
}

async function loadTrack(trackObject){
  const url = trackObject.url;
  const filenameNoExt = trackObject.display; 
  albumArtImg.style.display = 'none'; 
  const underscoreFilename = filenameNoExt.replace(/ /g, '_');
  const pathsToTry = [
      `visual/album_art/${underscoreFilename}.png`,      
      `visual/album_art/${filenameNoExt}.png`,           
      `visual/album_art/${encodeURIComponent(filenameNoExt)}.png`,
      `visual/album_art/${underscoreFilename.toLowerCase()}.png`, 
      `visual/album_art/${filenameNoExt.toLowerCase()}.png`,
      `visual/album_art/${encodeURIComponent(filenameNoExt.toLowerCase())}.png`
  ];
  let pathIndex = 0;
  function attemptLoad() {
      if (pathIndex >= pathsToTry.length) {
          albumArtImg.style.display = 'none'; 
          return;
      }
      const currentPath = pathsToTry[pathIndex];
      albumArtImg.onload = () => { albumArtImg.style.display = 'block'; };
      albumArtImg.onerror = () => { pathIndex++; attemptLoad(); };
      albumArtImg.src = currentPath;
  }
  attemptLoad();

  try{
    trackNameDiv.textContent = ""; 
    const r=await fetch(url);
    const ab=await r.arrayBuffer();
    audioBuffer=await audioContext.decodeAudioData(ab);
    trackNameDiv.classList.remove('fade-in');
    void trackNameDiv.offsetWidth;
    trackNameDiv.textContent = trackObject.display;
    trackNameDiv.classList.add('fade-in');
    currentTrack = trackObject;
    updateLikeButton();
    lastPlayedTrackUrl = trackObject.url; 
    waveformPeaks = getWaveformPeaks(audioBuffer, canvas.offsetWidth); 
    drawWaveform(); 
  }catch(e){
    console.error('loadTrack failed:', e); 
    trackNameDiv.textContent="Error loading track"; 
    audioBuffer = null;
    waveformPeaks = [];
    drawWaveform(); 
  }
}

function startSource(startTimeOffset) {
  if(source) { try{source.stop();}catch(e){} source=null; }
  const s = audioContext.createBufferSource();
  s.buffer = audioBuffer;
  s.connect(musicGain);
  s.loop = false;
  s.start(0, startTimeOffset);
  s.onended = () => {
    if(isPlaying && audioBuffer && (playHeadTime >= audioBuffer.duration - 0.1)) {
       playNext(); 
    }
  };
  return s;
}

function startRamp() {
  if (source && source.playbackRate) { source.playbackRate.value = 0.001; }
  targetVelocity = 1.0; 
}

function playAudio() {
  if(!audioBuffer) return; 
  if (!source) { source = startSource(playHeadTime); } 
  isPlaying = true;
  playButton.textContent = 'Pause';
  nextButton.classList.remove('hidden');
  likeButton.classList.remove('hidden');
}

function pauseAudio() {
  isPlaying = false;
  targetVelocity = 0; 
  playButton.textContent = 'Play';
  setTimeout(() => {
    if(!isPlaying && Math.abs(currentVelocity) < 0.01) {
      if(source) { try{source.stop();}catch(e){} source=null; }
    }
  }, 500);
}

async function playNext(){
  const wasPlaying = isPlaying;
  if(source) { try { source.stop(); } catch(e) {} source = null; }
  currentTrack = getNextTrackFromQueue(); 
  currentVelocity = 0;
  playHeadTime = 0;
  await loadTrack(currentTrack);
  if (wasPlaying) { playAudio(); startRamp(); } else { playButton.textContent = 'Play'; }
}

async function loadRandomTrack() {
    currentTrack = getNextTrackFromQueue(); 
    await loadTrack(currentTrack);
}

function updatePhysics() {
  const now = performance.now();
  const dt = (now - lastTimestamp) / 1000; 
  lastTimestamp = now;

  if(!audioBuffer) {
    requestAnimationFrame(updatePhysics);
    drawWaveform(); 
    return;
  }

  if (isScrubbing) {
    const lerpFactor = 0.5; 
    currentVelocity = currentVelocity + (targetVelocity - currentVelocity) * lerpFactor;
  } else {
    const target = isPlaying ? 1.0 : 0.0;
    const inertia = 10.0; 
    const diff = target - currentVelocity;
    if(Math.abs(diff) < 0.001) currentVelocity = target;
    else currentVelocity += diff * (dt * inertia);
  }

  if (source && source.playbackRate) {
    const newRate = Math.max(0, currentVelocity);
    source.playbackRate.setTargetAtTime(newRate, audioContext.currentTime, 0.01);
  } else if(currentVelocity !== 0 && !isPlaying) {
      currentVelocity *= 0.95; 
  }

  if (Math.abs(currentVelocity) > 0.005) { 
    playHeadTime += Math.max(0, currentVelocity) * dt;
    if(playHeadTime < 0) { playHeadTime = 0; currentVelocity = 0; }
    if(audioBuffer && playHeadTime > audioBuffer.duration) { playHeadTime = audioBuffer.duration; currentVelocity = 0; }
  }

  wheelRotation += (currentVelocity * 140) * dt;
  jogWheel.style.transform = `rotate(${wheelRotation}deg)`;
  drawWaveform(); 
  requestAnimationFrame(updatePhysics);
}

requestAnimationFrame(updatePhysics);

/* ================= INPUT HANDLERS ================= */

jogWheel.addEventListener('pointerdown', async (e) => {
  e.preventDefault();
  jogWheel.setPointerCapture(e.pointerId);
  if(audioContext.state === 'suspended') await audioContext.resume();
  isScrubbing = true;
  isHolding = true;
  lastPointerX = e.clientX;
  targetVelocity = 0; 
  if (audioBuffer && !source) { source = startSource(playHeadTime); if (source.playbackRate) source.playbackRate.value = 0; }
});

window.addEventListener('pointermove', (e) => {
  if (!isScrubbing) return;
  e.preventDefault();
  const dx = e.clientX - lastPointerX;
  lastPointerX = e.clientX;
  targetVelocity = dx * 0.15; 
});

window.addEventListener('pointerup', (e) => {
  if (!isScrubbing) return;
  isScrubbing = false;
  isHolding = false;
  if(playButton.textContent === 'Pause') { targetVelocity = 1; }
});

playButton.addEventListener('click',async()=>{
  if(audioContext.state === 'suspended') await audioContext.resume();
  if(!isPlaying) { playAudio(); startRamp(); } else { pauseAudio(); }
});

nextButton.addEventListener('click',async()=>{
  if(audioContext.state === 'suspended') await audioContext.resume();
  playNext(); 
});

volumeSlider.addEventListener('input',e=>{
  const v=parseFloat(e.target.value);
  musicGain.gain.setTargetAtTime(v,audioContext.currentTime, 0.1);
  localStorage.setItem('brrrt_music_volume',String(v));
});

/* ================= VISIBILITY HANDLER ================= */
// Logic:
// Desktop: Visibility change (tabs, minimize) -> KEEP PLAYING
// Mobile: Visibility change (home screen, switch app) -> MUTE
document.addEventListener("visibilitychange", () => {
  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) || (window.innerWidth < 980);
  
  if (document.hidden) {
    // If Hidden (Tab Switch OR Minimize)
    if (isMobile) {
      // Mobile: Mute
      if (isPlaying) {
         musicGain.gain.setTargetAtTime(0, audioContext.currentTime, 0.5);
      }
    }
    // Desktop: Do nothing (Continues playing). 
    // This ensures music plays when switching tabs.
    // Side effect: Music also plays when minimized on Desktop.
  } else {
    // If Visible
    // Restore volume if we were playing
    if (isPlaying) {
       const vol = parseFloat(volumeSlider.value);
       musicGain.gain.setTargetAtTime(vol, audioContext.currentTime, 0.5);
    }
  }
});
/* ====================================================== */

likeButton.addEventListener('click', async () => {
  const url = currentTrack.url;
  likes[url] = !likes[url];
  localStorage.setItem('trackLikes', JSON.stringify(likes));
  updateLikeButton();
  const trackName = currentTrack.display;
  const trackRef = db.collection("songs").doc(trackName);
  try {
      if (likes[url]) {
          await trackRef.set({ likes: firebase.firestore.FieldValue.increment(1) }, { merge: true });
      } else {
          await trackRef.set({ likes: firebase.firestore.FieldValue.increment(-1) }, { merge: true });
      }
  } catch (error) { console.error("Error updating likes:", error); }
});

function updateLikeButton(){
  const url = currentTrack ? currentTrack.url : '';
  likeButton.setAttribute('data-icon',likes[url]?'♥':'♡');
  likeButton.classList.toggle('liked',!!likes[url]);
}

const sfxGridInner=document.getElementById('sfx-grid-inner');
const sfxButtons=[];
const sfxBuffers={};
const sfxPath='audio/sfx/';
const sfxFiles=['sfx1.ogg','sfx2.ogg','sfx3.ogg','sfx4.ogg','sfx5.ogg','sfx6.ogg','sfx7.ogg','sfx8.ogg','sfx9.ogg', 'sfx10.ogg', 'sfx11.ogg','sfx12.ogg', 'sfx13.ogg','sfx14.ogg', 'sfx15.ogg','sfx16.ogg','sfx17.ogg','sfx18.ogg','sfx19.ogg','sfx20.ogg','sfx21.ogg','sfx22.ogg','sfx23.ogg','sfx24.ogg','sfx25.ogg','sfx26.ogg','sfx27.ogg','sfx28.ogg','sfx29.ogg','sfx30.ogg','sfx31.ogg','sfx32.ogg','sfx33.ogg','sfx34.ogg', 'sfx35.ogg','sfx36.ogg','sfx37.ogg','sfx38.ogg','sfx39.ogg','sfx40.ogg','sfx41.ogg','sfx42.ogg','sfx43.ogg','sfx44.ogg','sfx45.ogg','sfx46.ogg','sfx47.ogg','sfx48.ogg','sfx49.ogg','sfx50.ogg','sfx51.ogg','sfx52.ogg','sfx53.ogg','sfx54.ogg','sfx55.ogg','sfx56.ogg','sfx57.ogg','sfx58.ogg','sfx58.ogg','sfx59.ogg','sfx60.ogg','sfx61.ogg','sfx62.ogg','sfx63.ogg','sfx64.ogg','sfx65.ogg','sfx66.ogg','sfx67.ogg','sfx68.ogg','sfx69.ogg','sfx70.ogg','sfx71.ogg','sfx72.ogg','sfx73.ogg'];

for(let i=0;i<9;i++){
  const btn=document.createElement('div');
  btn.className='sfx-button';
  btn.innerHTML=`<div class="sfx-number">${i+1}</div>`;
  sfxGridInner.appendChild(btn);
  sfxButtons.push(btn);
}

async function loadSFX(url){
  if(sfxBuffers[url]) return sfxBuffers[url];
  try{
    const r=await fetch(url);
    const ab=await r.arrayBuffer();
    sfxBuffers[url]=await audioContext.decodeAudioData(ab);
    return sfxBuffers[url];
  }catch(e){ return null; }
}

function assignSFX(btn, url) {
  btn.onclick = async () => {
    if(audioContext.state === 'suspended') await audioContext.resume();
    const buf = await loadSFX(url);
    if(buf){
      const s = audioContext.createBufferSource();
      s.buffer = buf;
      s.connect(audioContext.destination);
      s.start(0);
      btn.classList.remove('flash-red');
      void btn.offsetWidth;
      btn.classList.add('flash-red');
    }
  }
}

function refreshSFX() {
  const available=[...sfxFiles];
  for(let i=available.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [available[i],available[j]]=[available[j],available[i]];
  }
  sfxButtons.forEach((btn, i) => {
    const file = available[i] || available[0];
    assignSFX(btn, sfxPath + file);
    setTimeout(() => {
      btn.classList.remove('flash-red');
      void btn.offsetWidth; 
      btn.classList.add('flash-red');
    }, i * 60);
  });
}

document.getElementById('refreshButton').addEventListener('click', async()=>{
  if(audioContext.state === 'suspended') await audioContext.resume();
  refreshSFX();
});

const partnersInner=document.getElementById('partners-strip-inner');
const partnersStrip = document.getElementById('partners-strip');
let isStripScrubbing = false;
let stripPosition = 0; 
let stripVelocity = 0; 
let stripStartRate = -100; 
let lastStripPointerX = 0;
let lastStripTimestamp = performance.now();
let setWidthPx = 0; 

function updateStripPhysics() {
  const now = performance.now();
  const dt = (now - lastStripTimestamp) / 1000; 
  lastStripTimestamp = now;
  if (setWidthPx === 0) { requestAnimationFrame(updateStripPhysics); return; }
  if (!isStripScrubbing) {
    const diff = stripStartRate - stripVelocity;
    if (Math.abs(diff) > 0.1) { stripVelocity += diff * (dt * 5.0); } else { stripVelocity = stripStartRate; }
  }
  stripPosition += stripVelocity * dt;
  if (stripPosition < -setWidthPx) { stripPosition += setWidthPx; } else if (stripPosition > 0) { stripPosition -= setWidthPx; }
  partnersInner.style.transform = `translate3d(${stripPosition}px, -50%, 0)`;
  requestAnimationFrame(updateStripPhysics);
}

function setupPartnersStrip() {
    const logoSet = partnersInner.innerHTML;
    partnersInner.innerHTML = logoSet + logoSet; 
    let totalWidth = 0;
    const firstSetChildren = partnersInner.children.length / 2;
    for(let i = 0; i < firstSetChildren; i++) {
        const child = partnersInner.children[i];
        if (child.offsetWidth > 0) {
            const style = getComputedStyle(child);
            totalWidth += child.offsetWidth + parseFloat(style.marginLeft) + parseFloat(style.marginRight);
        } else {
            setTimeout(setupPartnersStrip, 200); 
            return;
        }
    }
    setWidthPx = totalWidth;
    stripVelocity = stripStartRate; 
    requestAnimationFrame(updateStripPhysics); 
}

partnersStrip.addEventListener('pointerdown', (e) => {
    if (setWidthPx === 0) return;
    e.preventDefault(); 
    partnersStrip.setPointerCapture(e.pointerId);
    isStripScrubbing = true;
    lastStripPointerX = e.clientX;
    stripVelocity = 0; 
});
window.addEventListener('pointermove', (e) => {
  if (!isStripScrubbing) return;
  e.preventDefault();
  const dx = e.clientX - lastStripPointerX;
  lastStripPointerX = e.clientX;
  stripPosition += dx;
  partnersInner.style.transform = `translate3d(${stripPosition}px, -50%, 0)`;
});
window.addEventListener('pointerup', (e) => {
    if (!isStripScrubbing) return;
    isStripScrubbing = false;
});

const myEmail = "jony@brrrt.audio"; 
const copyEmailBtn = document.getElementById('copyEmailBtn');
const copyFeedback = document.getElementById('copyFeedback');
if(copyEmailBtn){
    copyEmailBtn.addEventListener('click', ()=>{
        navigator.clipboard.writeText(myEmail).then(()=>{ copyFeedback.textContent = "copied!"; });
    });
}

const sunSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`;
const moonSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`;
const toggleSwitch = document.querySelector('.theme-switch input[type="checkbox"]');
const iconContainer = document.getElementById('theme-icon-container');
const currentTheme = localStorage.getItem('theme');

function updateThemeIcon(theme) {
    iconContainer.innerHTML = theme === 'dark' ? moonSVG : sunSVG;
    iconContainer.classList.remove('icon-enter');
    void iconContainer.offsetWidth; 
    iconContainer.classList.add('icon-enter');
}

if (currentTheme) {
    document.documentElement.setAttribute('data-theme', currentTheme);
    if (currentTheme === 'dark') {
        toggleSwitch.checked = true;
        updateThemeIcon('dark');
    } else {
        document.documentElement.setAttribute('data-theme', 'light');
        updateThemeIcon('light');
    }
} else {
    document.documentElement.setAttribute('data-theme', 'light');
    updateThemeIcon('light');
}

function adjustVolumeForTheme(amount) {
    let currentVol = parseFloat(volumeSlider.value);
    let newVol = currentVol + amount;
    if(newVol > 1) newVol = 1;
    if(newVol < 0) newVol = 0;
    volumeSlider.value = newVol;
    musicGain.gain.setTargetAtTime(newVol, audioContext.currentTime, 0.1);
    localStorage.setItem('brrrt_music_volume', String(newVol));
}

function switchTheme(e) {
    if (e.target.checked) {
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('theme', 'dark');
        updateThemeIcon('dark');
        adjustVolumeForTheme(-0.4); 
    } else {
        document.documentElement.setAttribute('data-theme', 'light');
        localStorage.setItem('theme', 'light');
        updateThemeIcon('light');
        adjustVolumeForTheme(0.4); 
    }
}
toggleSwitch.addEventListener('change', switchTheme);
iconContainer.addEventListener('click', () => { toggleSwitch.click(); });

function getScrollTop() {
    return window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
}
window.addEventListener('scroll', () => {
    const arrow = document.getElementById('scroll-arrow');
    if (!arrow) return;
    const scrollY = getScrollTop();
    const fadePoint = 300; 
    let opacity = 1 - (scrollY / fadePoint);
    if (opacity < 0) opacity = 0;
    arrow.style.opacity = opacity;
});

window.addEventListener('load', () => {
  loadRandomTrack();
  refreshSFX();
  setupPartnersStrip(); 
});
</script>
</body>
</html>